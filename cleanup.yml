- hosts: nodes
  tasks:

  - stat:
      path: /etc/systemd/system/kubelet.service
    register: result
  
  - name: Stop kubelet
    systemd:
      name: kubelet
      state: stopped
      enabled: False
    when: result.stat.exists

  - name: Remove unit file
    file:
      path: /etc/systemd/system/kubelet.service
      state: absent

  - stat:
      path: /etc/systemd/system/kube-proxy.service
    register: result
  
  - name: Stop kube-proxy
    systemd:
      name: kube-proxy
      state: stopped
      enabled: False
    when: result.stat.exists

  - name: Remove unit file
    file:
      path: /etc/systemd/system/kube-proxy.service
      state: absent

  - name: Remove directories
    file:
      path: "{{ item }}"
      state: absent
    with_items:
      - /var/lib/kubelet
      - /etc/kubernetes

  - name: Remove binaries
    file:
      path: "/usr/local/bin/{{ item }}"
      state: absent
    with_items:
      - kubelet

- hosts: etcd
  tasks:
  - stat:
      path: /etc/systemd/system/etcd.service
    register: result

  - name: Stop etcd
    systemd:
      name: etcd
      state: stopped
      enabled: False
    when: result.stat.exists

  - name: Remove unit file
    file:
      path: /etc/systemd/system/etcd.service
      state: absent

  - name: Remove etcd directories
    file:
      path: "{{ item }}"
      state: absent
    with_items:
      - /var/lib/etcd
      - /etc/etcd

  - name: Remove binaries
    file:
      path: "/usr/local/bin/{{ item }}"
      state: absent
    with_items:
      - etcd   

- hosts: masters
  tasks:
  - stat: 
      path: "/etc/systemd/system/kube-controller-manager.service"
    register: result

  - name: Stop kube-controller-manager service
    systemd:
      name: kube-controller-manager
      state: stopped
      enabled: False
    when: result.stat.exists

  - stat: 
      path: "/etc/systemd/system/kube-scheduler.service"
    register: result

  - name: Stop kube-scheduler service
    systemd:
      name: kube-scheduler
      state: stopped
      enabled: False
    when: result.stat.exists

  - stat: 
      path: "/etc/systemd/system/kube-apiserver.service"
    register: result

  - name: Stop kube-apiserver service
    systemd:
      name: kube-apiserver
      state: stopped
      enabled: False
    when: result.stat.exists

  - name: Remove directories
    file:
      path: "{( item }}"
      state: absent
    with_items:
      - /etc/kubernetes

  - name: Remove binaries
    file:
      path: "/usr/local/bin/{{ item }}"
      state: absent
    with_items:
      - kube-apiserver
      - kube-controller-manager
      - kube-scheduler

- hosts: 127.0.0.1
  connection: local
  tasks:
  - name: Remove tmp cert dir
    file:
      path: ~/.kube-tmp/
      state: absent